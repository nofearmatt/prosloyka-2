# Аналитическая Платформа-Прослойка v1.0

## 1. О проекте

Эта система — не просто программа, а центральный "мост данных" для вашего бизнеса. Она решает три главные проблемы:

- **Сложность API:** Избавляет дашборды и другие сервисы от необходимости разбираться в тонкостях API Bitrix24.
- **Лимиты и Скорость:** Защищает Bitrix24 от перегрузок, собирая данные в фоновом режиме, и обеспечивает мгновенный доступ к ним.
- **Хаос в данных:** Централизованно собирает, очищает и структурирует информацию, создавая единый и достоверный "источник правды".

Проект построен с упором на надежность, прозрачность и простоту поддержки. Вы, как владелец, можете управлять ключевыми параметрами через простой конфигурационный файл, не погружаясь в код.

## 2. Как запустить (Требования: Docker и Docker Compose)

Процесс запуска максимально упрощен и не требует установки Python или баз данных на ваш компьютер — все работает внутри Docker.

1. **Клонируйте репозиторий** или скачайте и распакуйте архив с проектом.

2. **Создайте файл `.env`:** В папке проекта найдите файл `.env.example`. Скопируйте его и переименуйте копию в `.env`.

3. **Заполните `.env`:** Откройте файл `.env` и впишите ваши реальные данные. **Особенно важен `BITRIX24_WEBHOOK_URL`**.

   ```bash
   # Пример для Bitrix24: https://your-domain.bitrix24.ru/rest/1/xxxxxxxxxxxxxxxx/
   BITRIX24_WEBHOOK_URL="ВАШ_URL_ВЕБХУКА_ИЗ_BITRIX24"
   SERVICE_API_KEY="super-secret-key" # Придумайте любой секретный ключ
   ```

4. **Запустите проект:** Откройте терминал в папке проекта и выполните одну команду:
   ```bash
   docker-compose up --build
   ```
   При первом запуске Docker скачает образы и соберет контейнеры, это может занять несколько минут.

5. **Готово!** Сервис запущен.
   - **Проверить API:** Откройте в браузере `http://localhost:8000/docs`. Вы увидите интерактивную документацию Swagger, где можно тестировать API.
   - **Проверить логи:** В окне терминала, где вы запускали `docker-compose`, вы будете видеть логи работы сервиса в реальном времени.

## 3. Конфигурация (configs/config.yaml)

Это ваш главный пульт управления. Здесь вы решаете, **какие данные** и **как часто** собирать, не трогая код.

```yaml
# configs/config.yaml

# Настройки для интеграции с Bitrix24
bitrix24:
  # Настройки фоновых задач
  schedule:
    # Включить ли первоначальную историческую загрузку при старте сервиса?
    # true - да, false - нет. Рекомендуется true для первого запуска.
    initial_load_enabled: true
    # Как часто (в минутах) проверять наличие обновлений (для фоллбэка, если вебхуки не сработают).
    sync_interval_minutes: 60

  # Описание сущностей, которые мы собираем
  entities:
    # Настройки для сделок
    deals:
      # Список полей, которые нужно забирать из Bitrix24.
      # Названия должны соответствовать API Bitrix24.
      fields_to_collect:
        - "ID"
        - "TITLE"
        - "STAGE_ID"
        - "OPPORTUNITY"
        - "CURRENCY_ID"
        - "ASSIGNED_BY_ID"
        - "COMPANY_ID"
        - "CONTACT_ID"
        - "DATE_CREATE"
        - "CLOSEDATE"

    # Настройки для контактов
    contacts:
      fields_to_collect:
        - "ID"
        - "NAME"
        - "LAST_NAME"
        - "PHONE"
        - "EMAIL"
```

## 4. Структура проекта

```
/project_folder
├── app/                    # Основная папка с кодом приложения
│   ├── api/               # Логика API эндпоинтов (то, что видит дашборд)
│   ├── collectors/        # Модули, которые собирают данные из внешних систем
│   ├── processors/        # Модули, которые обрабатывают и сохраняют данные
│   ├── models/           # Модели данных (для базы и для API)
│   ├── core/             # Ядро приложения (конфигурация, логирование)
│   ├── db/               # Настройки подключения к базе данных
│   └── main.py           # Главный файл, запускающий сервис
├── configs/              # Папка с вашими файлами конфигурации
│   └── config.yaml       # Ваш "пульт управления"
├── .env.example          # Шаблон для переменных окружения (ключи, пароли)
├── Dockerfile            # Инструкция по сборке "контейнера" для приложения
├── docker-compose.yml    # Файл, который "дирижирует" всеми сервисами (приложение, БД, кэш)
└── README.md             # Эта инструкция
```

## 5. API

Для взаимодействия с прослойкой используется простое REST API. Все запросы должны содержать заголовок `X-API-KEY` с вашим секретным ключом из `.env` файла.

- **Интерактивная документация:** `http://localhost:8000/docs`
- **Примеры эндпоинтов:**
  - `GET /api/v1/deals` — получить список сделок из нашей базы.
  - `POST /api/v1/webhook/bitrix` — специальный адрес, который нужно указать в настройках вебхука в Bitrix24 для получения мгновенных обновлений.